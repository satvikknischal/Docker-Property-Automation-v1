#
# Tandoor Recipes - Recipe Manager & Meal Planner
# Documentation: https://docs.tandoor.dev/
#
# NOTE: Tandoor 2 bundles nginx inside the container (port 80)
# No separate nginx container needed
#

services:
  tandoor:
    image: vabene1111/recipes:${TANDOOR_VERSION}
    container_name: tandoor
    restart: unless-stopped
    env_file:
      - ../.env
    environment:
      # Database connection
      POSTGRES_HOST: tandoor-db
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${TANDOOR_DB_USER}
      POSTGRES_PASSWORD: ${TANDOOR_DB_PASSWORD}
      POSTGRES_DB: ${TANDOOR_DB_NAME}
      # Application settings
      SECRET_KEY: ${TANDOOR_SECRET_KEY}
      TZ: ${TZ}
      DEBUG: 0
      ALLOWED_HOSTS: '*'
      # Gunicorn settings
      GUNICORN_MEDIA: 0
      # Enable signup (set to 0 to disable after initial setup)
      ENABLE_SIGNUP: ${TANDOOR_ENABLE_SIGNUP}
      # Social auth (optional)
      # SOCIAL_PROVIDERS: allauth.socialaccount.providers.openid_connect
    volumes:
      # Static files (named volume recommended by docs)
      - tandoor-staticfiles:/opt/recipes/staticfiles
      # Nginx config (named volume - do not use bind mount per docs)
      - tandoor-nginx-config:/opt/recipes/nginx/conf.d
      # Media files (recipe images, etc.)
      - ./mediafiles:/opt/recipes/mediafiles
    expose:
      - "80" # Web UI (proxied via Nginx Proxy Manager)
    networks:
      - ${PROXY_NETWORK}
      - tandoor-internal
    depends_on:
      tandoor-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.docker.compose.project=tandoor"
      - "com.docker.compose.service=tandoor"

  tandoor-db:
    image: postgres:${POSTGRES_VERSION}
    container_name: tandoor-db
    restart: unless-stopped
    env_file:
      - ../.env
    environment:
      POSTGRES_USER: ${TANDOOR_DB_USER}
      POSTGRES_PASSWORD: ${TANDOOR_DB_PASSWORD}
      POSTGRES_DB: ${TANDOOR_DB_NAME}
      TZ: ${TZ}
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    networks:
      - tandoor-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${TANDOOR_DB_USER} -d ${TANDOOR_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - "com.docker.compose.project=tandoor"
      - "com.docker.compose.service=tandoor-db"

volumes:
  tandoor-staticfiles:
  tandoor-nginx-config:

networks:
  ${PROXY_NETWORK}:
    external: true
  tandoor-internal:
    driver: bridge
